<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Complete Payment - Your Store</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; padding: 40px; margin: 0; }
    .card { max-width: 520px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,.1); text-align: center; }
    h2 { color: #e74c3c; margin-bottom: 10px; }
    p { color: #555; margin: 10px 0; }
    .order-box { text-align: left; background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0; }
    .total { font-size: 1.5rem; font-weight: 700; color: #e74c3c; margin: 20px 0; }
    .pay-btn {
      width: 100%; padding: 16px; background: linear-gradient(45deg, #ff4757, #ff6b6b);
      color: #fff; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold;
      cursor: pointer; margin-top: 10px; transition: 0.3s;
    }
    .pay-btn:hover { background: linear-gradient(45deg, #ff6b6b, #ff4757); transform: translateY(-2px); }
    .cancel-link { display: block; margin-top: 25px; color: #e74c3c; text-decoration: underline; font-size: 0.95rem; }
  </style>
</head>
<body>

<div class="card">
  <h2>Complete Your Payment</h2>
  <p>Your order is reserved. Complete payment to confirm.</p>

  <% orders.forEach(o => { %>
    <div class="order-box">
      <strong>Order ID: <%= o.orderId %></strong><br><br>
      <% o.orderItems.forEach(item => { %>
        <div><%= item.product.productName %> - Size: <%= item.size %> × <%= item.quantity %></div>
      <% }) %>
    </div>
  <% }) %>

  <div class="total">Total: ₹<%= totalAmount.toFixed(2) %></div>

  <button class="pay-btn" onclick="retryPayment()">
    Pay Now ₹<%= totalAmount.toFixed(2) %>
  </button>

  <p style="margin-top: 20px; font-size: 0.9rem; color: #888;">
    Secure payment powered by Razorpay
  </p>

  <!-- Optional: Nice cancel button -->
  <a href="/orders" class="cancel-link" onclick="event.preventDefault(); clearCartAndRedirect('/orders')">
    ← Cancel and go back to My Orders
  </a>
</div>

<script>
  const mongoOrderId = "<%= orderIds %>";  // single order ID

  async function retryPayment() {
    try {
      const res = await fetch("/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          addressId: "<%= orders[0].address._id || '' %>",
          totalAmount: <%= totalAmount %>,
          coupon: "<%= orders[0].coupon || '' %>",
          retryOrderId: mongoOrderId
        })
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Failed to start payment");

      const options = {
        key: "<%= razorpayKey %>",
        amount: data.amount,
        currency: "INR",
        order_id: data.orderId,
        name: "Your Store",
        handler: async function (response) {
          const verifyRes = await fetch("/verify-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              razorpay_order_id: response.razorpay_order_id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature,
              mongoOrderId: mongoOrderId
            })
          });

          const result = await verifyRes.json();
          if (result.success) {
            window.location.href = `/order/view/${result.mongoOrderId}`;
          } else {
            Swal.fire('Payment Failed', 'Please try again.', 'error');
          }
        },
        modal: {
          ondismiss: () => {
            Swal.fire('Payment Cancelled', 'You can retry anytime.', 'info');
          }
        },
        theme: { color: "#ff4757" }
      };

      new Razorpay(options).open();

    } catch (err) {
      Swal.fire('Error', err.message || 'Something went wrong', 'error');
    }
  }

  // ——————————————————————————————————————
  // FIXED & BULLETPROOF CART CLEARING LOGIC
  // ——————————————————————————————————————
  (function () {
    if (!window.location.pathname.includes('/retry-payment')) return;

    let hasLeftPage = false;

    // Prevent back button from going back in history
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
      if (!hasLeftPage) clearCartAndRedirect('/orders');
    };

    // Clear cart on refresh / tab close / unload
    const clearOnExit = () => {
      if (hasLeftPage) return;
      navigator.sendBeacon && navigator.sendBeacon('/cart/clear');
    };

    window.addEventListener('beforeunload', clearOnExit);
    window.addEventListener('unload', clearOnExit);

    // Clear cart when user clicks any external link
    document.addEventListener('click', function (e) {
      const a = e.target.closest('a');
      if (a && a.href && !a.href.includes(location.pathname)) {
        hasLeftPage = true;
        navigator.sendBeacon && navigator.sendBeacon('/cart/clear');
      }
    });

    // Main function: clear cart + redirect
    window.clearCartAndRedirect = async function (url = '/orders') {
      if (hasLeftPage) return;
      hasLeftPage = true;

      await fetch('/cart/clear', {
        method: 'POST',
        keepalive: true,
        headers: { 'Content-Type': 'application/json' }
      }).catch(() => {});

      sessionStorage.clear();
      localStorage.clear();
      window.location.href = url;
    };
  })();
</script>

</body>
</html>