<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Payment - Your Store</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      margin: 0;
      min-height: 100vh;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      background: #fff;
      padding: 35px;
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      text-align: center;
    }
    h2 {
      color: #e74c3c;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    p {
      color: #555;
      margin: 12px 0;
      line-height: 1.5;
    }
    .order-box {
      text-align: left;
      background: #f8f9fa;
      padding: 18px;
      border-radius: 10px;
      margin: 18px 0;
      border-left: 4px solid #e74c3c;
    }
    .order-box strong {
      color: #2c3e50;
      font-size: 1.1rem;
    }
    .total {
      font-size: 1.7rem;
      font-weight: 800;
      color: #e74c3c;
      margin: 25px 0;
    }
    .pay-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s;
      box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3);
    }
    .pay-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(231, 76, 60, 0.4);
    }
    .cancel-link {
      display: block;
      margin-top: 30px;
      color: #e74c3c;
      text-decoration: none;
      font-weight: 500;
      font-size: 1rem;
    }
    .cancel-link:hover {
      text-decoration: underline;
    }
    .secure-badge {
      margin-top: 20px;
      font-size: 0.9rem;
      color: #7f8c8d;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>Complete Your Payment</h2>
  <p>Your order is reserved and waiting for payment.</p>

  <% orders.forEach(o => { %>
    <div class="order-box">
      <strong>Order ID: <%= o.orderId %></strong><br><br>
      <% o.orderItems.forEach(item => { %>
        <div>• <%= item.product.productName %> - Size: <%= item.size || 'N/A' %> × <%= item.quantity %> 
          (₹<%= item.price.toFixed(2) %> each)</div>
      <% }) %>
    </div>
  <% }) %>

  <div class="total">
    Total Amount: ₹<%= totalAmount.toFixed(2) %>
  </div>

  <button class="pay-btn" onclick="retryPayment()">
    Pay Now ₹<%= totalAmount.toFixed(2) %>
  </button>

  <div class="secure-badge">
    Secured by <strong>Razorpay</strong> • 256-bit encryption
  </div>

  <a href="/orders" class="cancel-link">
    ← Go back to My Orders
  </a>
</div>

<script>
  const mongoOrderId = "<%= orderIds %>";
  const displayOrderId = "<%= orders[0].orderId %>";
  const totalAmount = <%= totalAmount %>;

  async function retryPayment() {
    try {
      const response = await fetch("/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          retryOrderId: mongoOrderId,
          totalAmount: totalAmount
        })
      });

      const data = await response.json();

      if (!data.success) {
        return Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: data.message || 'Failed to create payment session. Please try again.'
        });
      }

      const options = {
        key: "<%= razorpayKey %>",
        amount: data.amount,
        currency: "INR",
        order_id: data.orderId,
        name: "Your Store",
        description: `Payment for Order #${displayOrderId}`,
        image: "/images/logo.png", // optional
        handler: async function (response) {
          const verifyResponse = await fetch("/verify-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              razorpay_order_id: response.razorpay_order_id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature,
              mongoOrderId: mongoOrderId
            })
          });

          const result = await verifyResponse.json();

          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'Payment Successful!',
              text: 'Thank you! Your order has been confirmed.',
              confirmButtonColor: '#27ae60'
            }).then(() => {
              window.location.href = `/order/view/${result.mongoOrderId}`;
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Payment Failed',
              text: 'Don’t worry! Your order is still saved. You can retry anytime from My Orders.',
            });
          }
        },
        modal: {
          ondismiss: function () {
            Swal.fire({
              icon: 'info',
              title: 'Payment Cancelled',
              text: 'No problem! Your order is safely saved. You can complete payment anytime from My Orders.',
              confirmButtonText: 'Go to My Orders',
              confirmButtonColor: '#3498db'
            }).then(() => {
              window.location.href = '/orders';
            });
          }
        },
        theme: { color: "#e74c3c" },
        prefill: {
          name: "<%= orders[0].address.fullname %>",
          contact: "<%= orders[0].address.phone %>"
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();

    } catch (err) {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'Network Error',
        text: 'Please check your internet connection and try again.'
      });
    }
  }
</script>

</body>
</html>