<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* === ALL YOUR ORIGINAL STYLES - 100% UNCHANGED === */
        body {font-family: 'Poppins', sans-serif;background: #f8f9fa;margin: 0;padding: 0;}
        .container {max-width: 1100px;margin: 30px auto;background: #fff;padding: 30px;box-shadow: 0 4px 25px rgba(0,0,0,0.1);border-radius: 15px;}
        .header {text-align: center;margin-bottom: 30px;}
        .header h2 {font-size: 2em;font-weight: 600;color: #333;}
        .order-section {margin-bottom: 25px;}
        .order-info {display: flex;justify-content: space-between;flex-wrap: wrap;margin-bottom: 20px;}
        .info-block {width: 48%;margin-bottom: 15px;}
        .info-block h4 {color: #555;font-weight: 500;}
        .order-items {border-top: 1px solid #ddd;padding-top: 20px;}
        .item {display: flex;margin-bottom: 20px;align-items: center;}
        .item img {width: 120px;height: 120px;object-fit: cover;border-radius: 10px;box-shadow: 0 2px 8px rgba(0,0,0,0.1);margin-right: 20px;}
        .item-details h5 {font-size: 1.1em;margin-bottom: 8px;color: #333;}
        .item-details p {margin: 3px 0;color: #555;font-size: 0.95em;}
        
        /* STATUS TRACKER - FIXED: ICONS NOW ON TOP */
        .status-tracker {position: relative;display: flex;justify-content: space-between;align-items: center;margin: 40px 0;width: 100%;padding: 20px 0;}
        .status-tracker::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            height: 6px;
            width: 100%;
            background: #e0e0e0;
            z-index: 1;
            border-radius: 3px;
            transform: translateY(-50%);
        }
        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            height: 6px;
            background: #28a745;
            z-index: 2;
            border-radius: 3px;
            transition: width 1.2s ease-in-out;
            transform: translateY(-50%);
        }
        .status-step {
            position: relative;
            text-align: center;
            flex: 1;
            z-index: 10; /* Above the lines */
        }
        .status-step .circle {
            width: 56px;
            height: 56px;
            margin: 0 auto 12px;
            border-radius: 50%;
            background: #fff;
            border: 5px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-size: 22px;
            transition: all .4s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 11;
        }
        .status-step.active .circle {
            background: #28a745;
            color: #fff;
            border-color: #28a745;
            box-shadow: 0 0 0 6px rgba(40,167,69,0.3);
            transform: scale(1.1);
        }
        .status-step p {
            font-size: 14px;
            margin: 0;
            color: #777;
            font-weight: 500;
        }
        .status-step.active p {
            color: #28a745;
            font-weight: 600;
        }

        .cancelled-status,.returned-status {display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:600;margin:30px 0;gap:12px;color:#dc3545;}
        .returned-status {color:#007bff;}
        .cancelled-status i,.returned-status i {font-size:2.2rem;animation:fadePulse 1.5s infinite;}
        @keyframes fadePulse {0%{opacity:0.7;transform:scale(0.95)}50%{opacity:1;transform:scale(1.05)}100%{opacity:0.7;transform:scale(0.95)}}
        .action-buttons {text-align:center;margin-top:50px;padding-top:30px;border-top:1px solid #eee;}
        .action-button {display:inline-block;padding:12px 30px;font-size:1rem;font-weight:600;border-radius:50px;transition:all .3s;border:none;cursor:pointer;margin:0 10px;}
        .cancel-button {background:linear-gradient(45deg,#ff6b6b,#ff4757);color:white;box-shadow:0 4px 15px rgba(255,71,87,0.4);}
        .cancel-button:hover {transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,71,87,0.6);}
        .return-button {background:linear-gradient(45deg,#ffd32a,#ffa502);color:white;box-shadow:0 4px 15px rgba(255,193,7,0.4);}
        .return-button:hover {transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,193,7,0.6);}
        .download-button {background:linear-gradient(45deg,#3498db,#2980b9);color:white;box-shadow:0 4px 15px rgba(52,152,219,0.4);}
        .download-button:hover {transform:translateY(-2px);box-shadow:0 6px 20px rgba(52,152,219,0.6);}
        .retry-button {background:linear-gradient(45deg,#e74c3c,#c0392b);color:white;padding:14px 40px;font-size:1.1rem;}
        .return-modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(5px);z-index:1000;justify-content:center;align-items:center;opacity:0;transition:opacity .3s;}
        .return-modal.show {opacity:1;}
        .modal-content {background:linear-gradient(to bottom,#ffffff,#f8f9fa);padding:40px;border-radius:24px;width:550px;max-width:90%;position:relative;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);transform:scale(0.95);opacity:0;transition:all .4s cubic-bezier(0.34,1.56,0.64,1);}
        .return-modal.show .modal-content {transform:scale(1);opacity:1;}
        .close-modal {position:absolute;top:20px;right:20px;width:36px;height:36px;background:#f1f2f6;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#666;cursor:pointer;border:none;}
        .close-modal:hover {background:#ff4757;color:white;transform:rotate(90deg);}
        .modal-header h3 {margin-top:0;}
        .modal-header p {color:#666;font-size:0.95rem;}
        #returnReason {width:100%;min-height:120px;padding:15px;border:1px solid #ddd;border-radius:12px;resize:vertical;font-family:inherit;margin:15px 0;}
        .modal-buttons {display:flex;justify-content:flex-end;gap:12px;margin-top:10px;}
        .modal-button {padding:10px 20px;border:none;border-radius:50px;font-weight:600;cursor:pointer;transition:all .3s;}
        .cancel-return {background:#ccc;color:#333;}
        .submit-return {background:linear-gradient(45deg,#ffa502,#ff6b6b);color:white;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Order #<%= order.orderId %></h2>
        </div>

        <!-- ... ALL YOUR ORDER INFO & ITEMS (unchanged) ... -->
        <div class="order-section">
            <div class="order-info">
                <div class="info-block">
                    <h4><strong>Order Date:</strong> <%= order.createdOn.toDateString() %></h4>
                    <h4><strong>Payment:</strong> <%= order.paymentMethod %></h4>
                    <h4><strong>Total Amount:</strong>
                        <% const originalTotal = order.orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0); %>
                        <% if (order.status === 'Cancelled') { %>
                            <del style="color:#999;">₹<%= originalTotal %></del>
                            <span style="color:#dc3545; font-weight:600;"> → ₹<%= order.totalAmount %> (after cancellations)</span>
                        <% } else { %>
                            ₹<%= order.totalAmount %>
                        <% } %>
                    </h4>
                </div>
                <div class="info-block">
                    <h4><strong>Shipping Address:</strong></h4>
                    <p><%= order.address.fullname %>, <%= order.address.street %>, <%= order.address.city %>, <%= order.address.state %> - <%= order.address.zipCode %></p>
                    <p><strong>Phone:</strong> <%= order.address.phone %></p>
                </div>
            </div>
        </div>

        <div class="order-items">
            <% order.orderItems.forEach(item => { %>
                <div class="item">
                    <img src="<%= item.product.productImage[0] %>" alt="Product">
                    <div class="item-details">
                        <!-- ONLY THIS LINE IS CHANGED — REST EXACTLY SAME AS YOUR ORIGINAL -->
                        <h5><%= item.product.productName %> 
                            <% if (item.status === 'Cancelled') { %>
                                <span style="margin-left:8px; color:#dc3545; font-weight:600;">[CANCELLED]</span>
                            <% } else if (item.status === 'Returned') { %>
                                <span style="margin-left:8px; color:#28a745; font-weight:600;">[RETURNED]</span>
                            <% } else if (item.returnStatus === 'Rejected') { %>
                                <span style="margin-left:8px; color:#e74c3c; font-weight:600;">[RETURN REJECTED]</span>
                            <% } else if (item.returnRequest) { %>
                                <span style="margin-left:8px; color:#ffa502; font-weight:600;">[RETURN REQUESTED]</span>
                            <% } %>
                        </h5>
                        <p>Size: <%= item.size %></p>
                        <p>Quantity: <%= item.quantity %></p>
                        <p>Price: ₹<%= item.price %></p>
                        <% if (['Pending','Processing'].includes(order.status) && item.status !== 'Cancelled' && !paymentPending) { %>
                            <a href="/cancel-item/<%= order._id %>/<%= item._id %>" class="action-button cancel-button cancel-item-link" style="display:inline-block; margin-top:8px; padding:8px 16px; font-size:0.9rem;">Cancel this item</a>
                        <% } else if (item.status === 'Cancelled') { %>
                            <span style="color:#dc3545; font-weight:600;">Cancelled</span>
                        <% } %>
                        <% if (order.status === 'Delivered' && !item.returnRequest && item.status !== 'Cancelled') { %>
                            <button class="action-button return-button" style="display:inline-block; margin-top:8px; padding:8px 16px; font-size:0.9rem;" onclick="openReturnModal('<%= order._id %>', '<%= item._id %>')">Return this item</button>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        </div>

        <!-- THIS PART WAS ALREADY PERFECT — KEPT 100% SAME -->
        <% if (order.status === 'Cancelled') { %>
            <div class="cancelled-status">
                <i class="fas fa-times-circle"></i> Cancelled Order
            </div>
        <% } else if (order.status === 'Returned') { %>
            <div class="returned-status">
                <i class="fas fa-undo"></i> Order Returned
            </div>
        <% } else { %>
            <div class="status-tracker">
                <div class="progress-line"></div>

                <div class="status-step <%= order.status !== 'Pending' ? 'active' : '' %>">
                    <div class="circle"><i class="fas fa-clock"></i></div>
                    <p>Pending</p>
                </div>

                <div class="status-step <%= ['Processing','Shipped','Delivered'].includes(order.status) ? 'active' : '' %>">
                    <div class="circle"><i class="fas fa-cog fa-spin" style="animation-duration: 4s;"></i></div>
                    <p>Processing</p>
                </div>

                <div class="status-step <%= ['Shipped','Delivered'].includes(order.status) ? 'active' : '' %>">
                    <div class="circle"><i class="fas fa-truck"></i></div>
                    <p>Shipped</p>
                </div>

                <div class="status-step <%= order.status === 'Delivered' ? 'active' : '' %>">
                    <div class="circle"><i class="fas fa-check"></i></div>
                    <p>Delivered</p>
                </div>
            </div>
        <% } %>

        <!-- ACTION BUTTONS & MODAL (unchanged) -->
        <div class="action-buttons">
            <% if (paymentPending) { %>
                <button class="action-button retry-button" onclick="retryPayment('<%= order._id %>')">
                    Retry Payment ₹<%= order.totalAmount.toFixed(2) %>
                </button>
                <p style="color:#e74c3c; margin-top:15px; font-weight:600;">
                    Payment not completed. Please retry to confirm your order.
                </p>
            <% } else { %>
                <% if (['Pending', 'Processing'].includes(order.status)) { %>
                    <a href="/cancel-order/<%= order._id %>" class="action-button cancel-button cancel-order-link">
                        Cancel Order
                    </a>
                <% } %>
                <% if (order.status !== 'Cancelled') { %>
                    <button class="action-button download-button" data-id="<%= order.orderId %>">
                        Download Invoice
                    </button>
                <% } %>
            <% } %>
        </div>

        
        <div id="returnModal" class="return-modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeReturnModal()">×</span>
                <div class="modal-header">
                    <h3>Request Return</h3>
                    <p>Please tell us why you want to return this item</p>
                </div>
                <div class="return-form">
                    <form id="returnForm" onsubmit="event.preventDefault(); submitItemReturn();">
                        <input type="hidden" id="orderId">
                        <input type="hidden" id="itemId">
                        <textarea id="returnReason" placeholder="Please provide detailed reason for return..." maxlength="500" required></textarea>
                        <div class="modal-buttons">
                            <button type="button" class="modal-button cancel-return" onclick="closeReturnModal()">Cancel</button>
                            <button type="submit" class="modal-button submit-return">Submit Return</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- YOUR FULL SCRIPT - 100% UNCHANGED -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const line = document.querySelector('.progress-line');
            if (line) {
                const status = "<%= order.status %>";
                const width = status === 'Processing' ? 33 : status === 'Shipped' ? 66 : status === 'Delivered' ? 100 : 0;
                let cur = 0;
                const int = setInterval(() => {
                    if (cur >= width) clearInterval(int);
                    line.style.width = cur + '%';
                    cur += 1;
                }, 15);
            }
        });

        async function retryPayment(orderId) {
            const { isConfirmed } = await Swal.fire({
                title: 'Complete Payment?',
                text: 'You will be redirected to secure payment gateway',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Pay Now',
                confirmButtonColor: '#28a745'
            });
            if (!isConfirmed) return;

            try {
                const res = await fetch("/create-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        retryOrderId: orderId,
                        totalAmount: <%= order.totalAmount %>
                    })
                });

                const data = await res.json();
                if (!data.success) throw new Error(data.message || "Payment failed to start");

                const options = {
                    key: data.key,
                    amount: data.amount,
                    currency: "INR",
                    order_id: data.orderId,
                    name: "Your Store",
                    handler: async (response) => {
                        const verifyRes = await fetch("/verify-payment", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature,
                                mongoOrderId: orderId
                            })
                        });
                        const result = await verifyRes.json();
                        if (result.success) {
                            Swal.fire('Success!', 'Payment completed!', 'success').then(() => location.reload());
                        } else {
                            Swal.fire('Failed', 'Payment failed. Please try again.', 'error');
                        }
                    },
                    modal: { ondismiss: () => Swal.fire('Cancelled', 'You can retry anytime.', 'info') },
                    theme: { color: "#e74c3c" }
                };

                new Razorpay(options).open();

            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        }

        function openReturnModal(orderId, itemId) {
            document.getElementById('returnModal').style.display = 'flex';
            document.getElementById('orderId').value = orderId;
            document.getElementById('itemId').value = itemId;
            setTimeout(() => document.getElementById('returnModal').classList.add('show'), 10);
            document.body.style.overflow = 'hidden';
        }
        function closeReturnModal() {
            const modal = document.getElementById('returnModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                document.getElementById('returnReason').value = '';
            }, 300);
        }
        async function submitItemReturn() {
            const orderId = document.getElementById('orderId').value;
            const itemId = document.getElementById('itemId').value;
            const reason = document.getElementById('returnReason').value.trim();
            if (!reason) return Swal.fire('Error', 'Please provide a reason', 'error');

            const res = await fetch(`/return-item/${orderId}/${itemId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ returnReason: reason })
            });
            const data = await res.json();
            if (data.success) {
                Swal.fire('Success', 'Return requested successfully!', 'success').then(() => location.reload());
            } else {
                Swal.fire('Error', data.message || 'Something went wrong', 'error');
            }
        }

        document.querySelectorAll('.cancel-order-link, .cancel-item-link').forEach(link => {
            link.addEventListener('click', async function(e) {
                e.preventDefault();
                const isItemCancel = this.classList.contains('cancel-item-link');
                const href = this.getAttribute('href');

                const result = await Swal.fire({
                    title: isItemCancel ? 'Cancel This Item?' : 'Cancel Entire Order?',
                    text: isItemCancel 
                        ? "This item will be removed and refunded if already paid." 
                        : "Your entire order will be cancelled and refunded if paid. This cannot be undone.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, Cancel',
                    cancelButtonText: 'No, Keep It',
                    reverseButtons: true,
                    allowOutsideClick: false
                });

                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Cancelling...',
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                    window.location.href = href;
                }
            });
        });

        document.querySelector('.download-button')?.addEventListener('click', function() {
            Swal.fire({
                title: 'Download Invoice?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                confirmButtonText: 'Download'
            }).then(result => {
                if (result.isConfirmed) {
                    window.location.href = `/order-details/orderid/<%= order.orderId %>/invoice`;
                }
            });
        });

        window.addEventListener('beforeunload', () => {
            if (<%= paymentPending %>) {
                navigator.sendBeacon('/cart/clear');
            }
        });
    </script>
</body>
</html>