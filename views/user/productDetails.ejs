<%- include("../../views/partials/user/header") %>
<html lang="zxx" class="no-js">

<head>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="img/fav.png">
    <title><%= product ? product.productName + ' | Karma Shop' : 'Product Not Found' %></title>

    <link rel="stylesheet" href="css/linearicons.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/themify-icons.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/owl.carousel.css">
    <link rel="stylesheet" href="css/nice-select.css">
    <link rel="stylesheet" href="css/nouislider.min.css">
    <link rel="stylesheet" href="css/ion.rangeSlider.css" />
    <link rel="stylesheet" href="css/ion.rangeSlider.skinFlat.css" />
    <link rel="stylesheet" href="css/main.css">

    <style>
        /* Image Zoom */
        .img-zoom-container {position:relative;overflow:hidden;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);}
        #productImg{display:block;width:100%;transition:transform .5s ease;}
        .img-zoom-container:hover #productImg{transform:scale(1.6);cursor:crosshair;transform-origin:var(--x,50%) var(--y,50%);}

        /* Thumbnails */
        .product-thumbnails{margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;}
        .thumbnail{border:2px solid #eee;border-radius:8px;overflow:hidden;cursor:pointer;transition:all .3s;}
        .thumbnail:hover{border-color:#333;transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,.1);}
        .thumbnail img{width:70px;height:70px;object-fit:cover;}

        /* Size Buttons */
        .size-btn{
            width:42px;height:42px;border-radius:50%;border:2px solid #333;background:#fff;
            color:#333;font-weight:700;font-size:14px;cursor:pointer;margin:0 8px 8px 0;
            display:inline-flex;align-items:center;justify-content:center;
            transition:all .3s ease;box-shadow:0 3px 8px rgba(0,0,0,.1);
        }
        .size-btn:hover:not(.out-of-stock){transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.18);}
        .size-btn.selected{background:#333;color:#fff;transform:scale(1.08);box-shadow:0 5px 15px rgba(0,0,0,.2);}
        
        /* ONLY RED CROSS - NO GRAY, NO DISABLE */
        .size-btn.out-of-stock{
            position:relative;
        }
        .size-btn.out-of-stock::after{
            content:'';
            position:absolute;
            top:50%;
            left:15%;
            width:70%;
            height:3px;
            background:#e74c3c;
            transform:translateY(-50%) rotate(-45deg);
            border-radius:3px;
        }

        /* Buttons */
        .primary-btn{padding:10px 24px;font-weight:600;font-size:14px;border-radius:30px;transition:all .3s;}
        .primary-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.15);}
        .primary-btn:disabled{background:#ccc;cursor:not-allowed;opacity:0.7;}

        /* Offer Badge */
        .flipkart-offer{display:inline-flex;align-items:center;gap:6px;background:#e8f5e9;color:#2e7d32;
            font-size:13px;font-weight:600;padding:4px 9px;border:1px solid #81c784;border-radius:6px;margin-top:6px;}
        .flipkart-offer i{color:#4caf50;}

        @media (max-width:768px){
            .size-btn{width:38px;height:38px;font-size:13px;margin:0 6px 8px 0;}
            .thumbnail img{width:60px;height:60px;}
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <!-- Breadcrumb -->
    <section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Product Details</h1>
                    <nav class="d-flex align-items-center">
                        <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="/shop">Shop<span class="lnr lnr-arrow-right"></span></a>
                        <a>Product Details</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- Product Details -->
    <div class="product_image_area">
        <div class="container">
            <% if (product) { %>
                <% 
                    const totalStock = Object.values(product.sizes || {}).reduce((a, b) => a + (b || 0), 0);
                    const isInStock = totalStock > 0;
                %>

                <div class="row s_product_inner">
                    <!-- Images -->
                    <div class="col-lg-6">
                        <div class="img-zoom-container">
                            <img id="productImg" class="img-fluid" src="<%= product.productImage[0] %>" alt="<%= product.productName %>">
                        </div>
                        <% if (product.productImage.length > 1) { %>
                            <div class="product-thumbnails mt-4">
                                <% product.productImage.forEach(image => { %>
                                    <div class="thumbnail" onclick="changeImage('<%= image %>')">
                                        <img src="<%= image %>" alt="thumb">
                                    </div>
                                <% }) %>
                            </div>
                        <% } %>
                    </div>

                    <!-- Details -->
                    <div class="col-lg-5 offset-lg-1">
                        <div class="s_product_text">
                            <h3><%= product.productName %></h3>
                            <h2>₹<%= (product.finalPrice || product.salePrice).toFixed(2) %></h2>

                            <ul class="list">
                                <li><a class="active"><span>Category</span> : <%= product.category.name %></a></li>
                                <li>
                                    <a>
                                        <span>Availability</span> : 
                                        <% if (isInStock) { %>
                                            <strong style="color:#28a745;">In Stock</strong>
                                            <% if (totalStock <= 5) { %>
                                                <span style="color:#e74c3c;font-weight:600;"> (Only <%= totalStock %> left!)</span>
                                            <% } %>
                                        <% } else { %>
                                            <strong style="color:#e74c3c;">Out of Stock</strong>
                                        <% } %>
                                    </a>
                                </li>

                                <% 
                                    const pOffer = product.offerPercentage || 0;
                                    const cOffer = product.category?.categoryOffer || 0;
                                    const best = Math.max(pOffer, cOffer);
                                    const source = pOffer > cOffer ? 'Product' : (cOffer > 0 ? 'Category' : null);
                                %>
                                <% if (best > 0) { %>
                                    <li>
                                        <div class="flipkart-offer">
                                            <i class="ti-tag"></i> <%= best %>% <%= source %> Offer
                                        </div>
                                    </li>
                                <% } %>
                            </ul>

                            <p style="margin:20px 0;line-height:1.7;color:#555;"><%= product.description %></p>

                            <!-- Size Selection -->
                            <% if (isInStock) { %>
                                <div style="margin:30px 0;">
                                    <strong style="font-size:16px;color:#222;">Select Size:</strong><br><br>
                                    <% ['6','7','8','9'].forEach(size => { %>
                                        <% const stock = product.sizes?.[size] || 0; %>
                                        <% const available = stock > 0; %>
                                        <button class="size-btn <%= !available ? 'out-of-stock' : '' %>"
                                                onclick="selectSize(this, '<%= size %>', <%= available %>)"
                                                data-size="<%= size %>">
                                            <%= size %>
                                        </button>
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <div style="margin:30px 0;padding:15px;background:#fff5f5;border:1px solid #ffcdd2;border-radius:8px;">
                                    <p style="color:#c62828;font-weight:600;margin:0;">
                                        This product is currently unavailable in all sizes
                                    </p>
                                </div>
                            <% } %>

                            <!-- Action Buttons -->
                            <div class="card_area d-flex align-items-center flex-wrap gap-3">
                                <% if (isInStock) { %>
                                    <button class="primary-btn" id="addCartBtn" onclick="addToCart('<%= product._id %>')">
                                        Add to Cart
                                    </button>
                                <% } else { %>
                                    <button class="primary-btn" disabled>Out of Stock</button>
                                <% } %>
                                <button class="primary-btn" style="background:#f8f9fa;color:#333;border:2px solid #ddd;"
                                        onclick="addToWishlist('<%= product._id %>')">
                                    Add to Wishlist
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <div class="text-center py-5 my-5">
                    <i class="fa fa-box-open" style="font-size:80px;color:#ddd;"></i>
                    <h2 class="mt-4">Product Not Found</h2>
                    <p class="text-muted mb-4">Sorry, this product is no longer available.</p>
                    <a href="/shop" class="primary-btn">Continue Shopping</a>
                </div>
            <% } %>
        </div>
    </div>

    
    <section class="related-product-area section_gap_bottom" style="background:#f8f9fa;padding:70px 0;">
        <div class="container">
            <div class="row justify-content-center mb-5">
                <div class="col-lg-6 text-center">
                    <h1>Related Products</h1>
                    <p>Explore similar items you might love</p>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-9">
                    <div class="row">
                        <% if (deals?.length > 0) { %>
                            <% deals.forEach(p => { %>
                                <% const rStock = Object.values(p.sizes||{}).reduce((a,b)=>a+(b||0),0); %>
                                <div class="col-lg-4 col-md-6 mb-4">
                                    <div class="single-related-product d-flex align-items-center p-3 rounded shadow-sm <%= rStock === 0 ? 'opacity-75' : '' %>">
                                        <a href="/product?id=<%= p._id %>"><img src="<%= p.productImage[0] %>" width="80" class="rounded"></a>
                                        <div class="desc ml-3">
                                            <a href="/product?id=<%= p._id %>" class="title d-block"><%= p.productName %></a>
                                            <div class="price mt-1">
                                                <strong>₹<%= (p.finalPrice || p.salePrice).toFixed(2) %></strong>
                                                <% if (p.regularPrice > p.finalPrice) { %>
                                                    <del class="text-muted ml-2">₹<%= p.regularPrice.toFixed(2) %></del>
                                                <% } %>
                                                <% if (rStock === 0) { %>
                                                    <span class="d-block text-danger mt-1"><small>Out of Stock</small></span>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p class="text-center text-muted w-100">No related products found.</p>
                        <% } %>
                    </div>
                </div>
                <div class="col-lg-3">
                    <a href="/shop"><img src="img/category/c5.jpg" class="img-fluid rounded shadow" alt="Shop"></a>
                </div>
            </div>
        </div>
    </section>

    <script>
        function changeImage(src) {
            document.getElementById('productImg').src = src;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.img-zoom-container');
            if (container) {
                container.addEventListener('mousemove', e => {
                    const r = container.getBoundingClientRect();
                    const x = ((e.clientX - r.left) / r.width) * 100;
                    const y = ((e.clientY - r.top) / r.height) * 100;
                    container.style.setProperty('--x', x + '%');
                    container.style.setProperty('--y', y + '%');
                });
            }
        });

        function selectSize(btn, size, available) {
            if (!available) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Out of Stock',
                    text: `Size ${size} is currently not available`,
                    timer: 2500,
                    showConfirmButton: false
                });
                return;
            }
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function addToCart(id) {
            const selected = document.querySelector('.size-btn.selected');
            if (!selected || selected.classList.contains('out-of-stock')) {
                Swal.fire('Oops!', 'Please select an available size', 'warning');
                return;
            }
            fetch('/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId: id, size: selected.dataset.size, quantity: 1 })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    Swal.fire({
                        icon: 'success', title: 'Added!', text: 'Item added to cart',
                        showCancelButton: true, confirmButtonText: 'View Cart'
                    }).then(r => r.isConfirmed && (location.href = '/cart'));
                } else throw new Error(d.message);
            })
            .catch(() => Swal.fire('Error', 'Failed to add to cart', 'error'));
        }

        function addToWishlist(id) {
            fetch('/wishlist-add', { method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId: id })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    Swal.fire('Success', d.message || 'Added to wishlist!', 'success')
                        .then(r => r.isConfirmed && (location.href = '/wishlist'));
                } else throw new Error(d.message);
            })
            .catch(() => Swal.fire('Error', 'Could not add to wishlist', 'error'));
        }
    </script>

<%- include("../../views/partials/user/footer") %>