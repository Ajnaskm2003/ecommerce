<%- include("../../views/partials/admin/header") %>
<head>
   <style>
       .thumbnails-container { display: flex; overflow-x: auto; }
       .thumbnail { margin-right: 10px; }
       .input-upload { position: relative; }
       .error-message { color: red; display: none; }
       .image-container { position: relative; display: inline-block; margin: 10px; }
       .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
       .delete-btn:hover { background: rgba(255,0,0,1); }
   </style>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.2/dist/sweetalert2.min.css">
</head>

<section class="content-main">
   <div class="row">
       <div class="col-9">
           <div class="content-header">
               <h2 class="content-title">Edit Product</h2>
           </div>
       </div>
       <div class="col-lg-6">
           <div class="card mb-4">
               <div class="card-body">
                   <form id="editProductForm" method="post" action="/admin/editProduct/<%= product._id %>" enctype="multipart/form-data">
                       
                       <!-- Hidden fields -->
                       <input type="hidden" name="deletedImages" id="deletedImages" value="">
                       <input type="hidden" name="croppedImage" id="croppedImageData">

                       <div class="mb-4">
                           <label for="product_name" class="form-label">Product Name</label>
                           <input type="text" name="productName" value="<%= product.productName %>" class="form-control border" id="product_name">
                           <div id="productName-error" class="error-message"></div>
                       </div>
                      
                       <div class="mb-4">
                           <label class="form-label">Full description</label>
                           <textarea name="descriptionData" class="form-control border" rows="4"><%= product.description %></textarea>
                           <div id="description-error" class="error-message"></div>
                       </div>

                       <div class="row">
                           <div class="col-lg-4">
                               <div class="mb-4">
                                   <label class="form-label">Regular price</label>
                                   <input placeholder="$" name="regularPrice" type="number" step="0.01" value="<%= product.regularPrice %>" class="form-control border" id="regularPrice">
                                   <div id="regularPrice-error" class="error-message"></div>
                               </div>
                           </div>
                           <div class="col-lg-4">
                               <div class="mb-4">
                                   <label class="form-label">Offer Percentage (%) <small class="text-muted">(Max 90%)</small></label>
                                   <input name="offerPercentage" type="number" min="0" max="90" step="1" value="<%= product.offerPercentage || 0 %>" class="form-control border" id="offerPercentage">
                                   <div id="offerPercentage-error" class="error-message"></div>
                               </div>
                           </div>
                           <div class="col-lg-4">
                               <div class="mb-4">
                                   <label class="form-label">Sale price</label>
                                   <input name="salePrice" type="number" step="0.01" value="<%= product.salePrice %>" class="form-control border" id="salePrice" readonly>
                               </div>
                           </div>
                       </div>

                       <!-- Total Quantity - Read only -->
                       <div class="row">
                           <div class="col-lg-4">
                               <div class="mb-4">
                                   <label class="form-label">Total Quantity</label>
                                   <input name="quantity" type="number" value="<%= product.quantity %>" class="form-control border" id="quantity" readonly style="background:#f9f9f9;">
                               </div>
                           </div>
                       </div>

                       <div class="row">
                           <div class="col-lg-4">
                               <div class="mb-4">
                                   <label for="size-6">Size 6 Quantity:</label>
                                   <input type="number" id="size-6" name="sizes[6]" min="0" class="form-control" value="<%= product.sizes?.[6] || 0 %>">
                                   <label for="size-7">Size 7 Quantity:</label>
                                   <input type="number" id="size-7" name="sizes[7]" min="0" class="form-control" value="<%= product.sizes?.[7] || 0 %>">
                                   <label for="size-8">Size 8 Quantity:</label>
                                   <input type="number" id="size-8" name="sizes[8]" min="0" class="form-control" value="<%= product.sizes?.[8] || 0 %>">
                                   <label for="size-9">Size 9 Quantity:</label>
                                   <input type="number" id="size-9" name="sizes[9]" min="0" class="form-control" value="<%= product.sizes?.[9] || 0 %>">
                                   <small id="size-error" class="text-danger"></small>
                               </div>
                           </div>
                       </div>
                      
                       <div class="card-body">
                           <div class="row gx-2">
                               <div class="col-sm-6 mb-3">
                                   <label class="form-label">Category</label>
                                   <select class="form-select border" style="width: 150px;" name="category" required>
                                        <% for(let i=0; i < category.length; i++) { %>
                                            <option value="<%= category[i]._id %>" 
                                                <%= product.category && product.category.toString() === category[i]._id.toString() ? 'selected' : '' %>>
                                                <%= category[i].name %>
                                            </option>
                                        <% } %>   
                                    </select>
                                   <div id="category-error" class="error-message"></div>
                               </div>
                           </div>
                       </div>
                       
                       <!-- Current Images -->
                       <div class="card mb-2">
                           <div class="card-header">
                               <h4>Current Images</h4>
                           </div>
                           <div class="card-body">
                               <div class="row" id="currentImagesRow">
                                   <% for(let i=0; i < product.productImage.length; i++) { %>
                                       <div class="col-md-3 mb-3 image-item">
                                           <div class="position-relative">
                                               <img src="<%= product.productImage[i] %>" class="img-fluid rounded" alt="Product image"
                                                    style="width: 100%; height: 150px; object-fit: cover;">
                                               <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px;"
                                                       onclick="removeImage('<%= product.productImage[i] %>', this)">
                                                   <i class="fas fa-times"></i>
                                               </button>
                                           </div>
                                       </div>
                                   <% } %>
                               </div>
                           </div>
                       </div>

                       <!-- CROPPING SECTION - FULLY WORKING -->
                       <div class="card mb-2">
                           <div class="card-header">
                               <h4>Add New Image (with Crop)</h4>
                           </div>
                           <div class="card-body text-center">
                               <button type="button" class="btn btn-primary mb-3" id="chooseImageBtn">
                                   Choose Image
                               </button>

                               <!-- Hidden file input -->
                               <input type="file" id="imageInput" accept="image/*" style="display:none;">

                               <!-- Cropper container -->
                               <div id="cropperWrapper" style="display:none; margin:20px 0; max-height:500px;">
                                   <img id="imageToCrop" style="max-width:100%;">
                               </div>

                               <button type="button" class="btn btn-success mb-3" id="cropButton" style="display:none;">
                                   Crop & Use Image
                               </button>

                               <div id="croppedPreview" style="margin-top:15px; display:none;">
                                   <p><strong>Cropped Image Ready:</strong></p>
                                   <img id="croppedImg" style="max-height:200px; border:2px solid #28a745; border-radius:8px;">
                               </div>

                               <div id="images-error" class="error-message mt-2"></div>
                           </div>
                       </div>

                       <div>
                           <button type="submit" class="btn btn-md rounded font-sm hover-up" id="updatebtn">Update</button>
                       </div>
                   </form>
               </div>
           </div>
       </div>
   </div>
</section>

<%- include("../../views/partials/admin/footer") %>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.2/dist/sweetalert2.all.min.js"></script>

<script>
let imagesToDelete = [];
let cropper = null;

// Remove current image
function removeImage(path, btn) {
    const remaining = document.querySelectorAll('#currentImagesRow .image-item').length;
    const hasCropped = !!document.getElementById('croppedImageData').value;

    if (remaining === 1 && !hasCropped) {
        Swal.fire('Warning', 'You must crop a new image first before deleting the last one.', 'warning');
        return;
    }

    if (!imagesToDelete.includes(path)) imagesToDelete.push(path);
    document.getElementById('deletedImages').value = JSON.stringify(imagesToDelete);
    btn.closest('.image-item').remove();
}

// FULLY WORKING CROPPING
document.getElementById('chooseImageBtn').addEventListener('click', () => {
    document.getElementById('imageInput').click();
});

document.getElementById('imageInput').addEventListener('change', function(e) {
    if (!e.target.files[0]) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        const img = document.getElementById('imageToCrop');
        img.src = ev.target.result;

        document.getElementById('cropperWrapper').style.display = 'block';
        document.getElementById('cropButton').style.display = 'block';
        document.getElementById('croppedPreview').style.display = 'none';

        if (cropper) cropper.destroy();

        cropper = new Cropper(img, {
            aspectRatio: 1,
            viewMode: 2,
            autoCropArea: 0.8,
            responsive: true,
            background: false,
            modal: true,
            guides: true,
            highlight: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
            dragMode: 'move'
        });
    };
    reader.readAsDataURL(e.target.files[0]);
});

document.getElementById('cropButton').addEventListener('click', function() {
    if (!cropper) return;

    cropper.getCroppedCanvas({ width: 800, height: 800 }).toBlob(blob => {
        const url = URL.createObjectURL(blob);
        document.getElementById('croppedImg').src = url;
        document.getElementById('croppedPreview').style.display = 'block';

        const reader = new FileReader();
        reader.onload = () => {
            document.getElementById('croppedImageData').value = reader.result;
        };
        reader.readAsDataURL(blob);

        Swal.fire('Success!', 'Image cropped and ready to upload!', 'success');

        // Clean up
        document.getElementById('cropperWrapper').style.display = 'none';
        document.getElementById('cropButton').style.display = 'none';
        cropper.destroy();
        cropper = null;
    }, 'image/jpeg', 0.9);
});

// Your existing functions
function calculateSalePrice() {
    const regular = parseFloat(document.getElementById('regularPrice').value) || 0;
    const offer = parseFloat(document.getElementById('offerPercentage').value) || 0;
    const sale = regular - (regular * offer / 100);
    document.getElementById('salePrice').value = sale.toFixed(2);
}

function updateMainQuantity() {
    const total = 
        (parseInt(document.getElementById('size-6').value) || 0) +
        (parseInt(document.getElementById('size-7').value) || 0) +
        (parseInt(document.getElementById('size-8').value) || 0) +
        (parseInt(document.getElementById('size-9').value) || 0);
    document.getElementById('quantity').value = total;
}

// Auto-correct offer percentage
document.getElementById('offerPercentage')?.addEventListener('input', function() {
    if (this.value > 90) {
        this.value = 90;
        Swal.fire('Info', 'Maximum offer is 90%', 'info');
    }
    calculateSalePrice();
});

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('regularPrice')?.addEventListener('input', calculateSalePrice);
    document.getElementById('offerPercentage')?.addEventListener('input', calculateSalePrice);

    ['size-6', 'size-7', 'size-8', 'size-9'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', updateMainQuantity);
    });

    calculateSalePrice();
    updateMainQuantity();

    // Form submit with validation
    document.getElementById('editProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Simple validation
        let valid = true;
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

        if (!this.productName.value.trim()) valid = false;
        if (!this.descriptionData.value.trim()) valid = false;
        if (document.getElementById('regularPrice').value <= 0) valid = false;

        const hasImage = document.querySelectorAll('#currentImagesRow .image-item').length > 0 || 
                        document.getElementById('croppedImageData').value;

        if (!hasImage) {
            document.getElementById('images-error').textContent = 'At least one image is required';
            document.getElementById('images-error').style.display = 'block';
            valid = false;
        }

        if (!valid) return;

        const btn = document.getElementById('updatebtn');
        btn.disabled = true;
        btn.innerHTML = 'Updating...';

        try {
            const res = await fetch(this.action, {
                method: 'POST',
                body: new FormData(this)
            });
            const data = await res.json();

            if (data.success) {
                Swal.fire('Success!', 'Product updated!', 'success').then(() => location.href = '/admin/products');
            } else {
                Swal.fire('Error', data.message || 'Update failed', 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Network error', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Update';
        }
    });
});
</script>