<%- include("../../views/partials/admin/header") %>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css">
</head>
<style>
    /* Custom CSS for error messages and form styling */
    .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
        display: block;
    }

    .form-control {
        border: 1px solid #ced4da;
        padding: 0.5rem;
        border-radius: 4px;
        width: 100%;
        margin-bottom: 1rem;
    }

    .form-control:invalid {
        border-color: #dc3545;
    }

    .form-control:focus:invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .form-label {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .form-select {
        border: 1px solid #ced4da;
        padding: 0.5rem;
        border-radius: 4px;
        width: 100%;
        margin-bottom: 1rem;
    }

    .form-select:invalid {
        border-color: #dc3545;
    }

    .form-select:focus:invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .btn {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #0056b3;
    }

    .preview-container {
        margin-top: 1rem;
    }

    .cropped-preview {
        max-width: 150px;
        max-height: 150px;
        display: block;
        margin-top: 10px;
        border: 1px solid #eee;
    }

    .remove-btn {
        margin-top: 0.5rem;
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
    }

    .remove-btn:hover {
        background-color: #c82333;
    }

    .image-upload-container {
        margin-bottom: 1rem;
    }

    .image-cropper {
        margin-top: 1rem;
        display: none;
    }

    .cropper-container {
        max-width: 100%;
    }

    .thumbnail {
        margin-right: 10px;
        margin-bottom: 10px;
    }

    .thumbnails-container {
        display: flex;
        flex-wrap: wrap;
    }
</style>
<section class="content-main">
    <div class="row">
        <div class="col-9">
            <div class="content-header">
                <h2 class="content-title">Add New Product</h2>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-body">
                    <form id="productForm" method="post" action="/admin/addProducts" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="product_name" class="form-label">Product Name</label>
                            <input type="text" placeholder="Type here" name="productName" class="form-control" id="product_name">
                            <span id="productName-error" class="error-message"></span>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Full description</label>
                            <textarea placeholder="Type here" id="descriptionid" name="description" class="form-control" rows="4"></textarea>
                            <span id="description-error" class="error-message"></span>
                        </div>
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Regular price</label>
                                    <input placeholder="$" name="regularPrice" type="text" class="form-control">
                                    <span id="regularPrice-error" class="error-message"></span>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Sale price</label>
                                    <input placeholder="$" name="salePrice" type="text" class="form-control">
                                    <span id="salePrice-error" class="error-message"></span>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Quantity</label>
                                    <input placeholder="" name="quantity" type="text" class="form-control" id="totalQuantity">
                                    <span id="quantity-error" class="error-message"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label for="size-6">Size 6 Quantity:</label>
                                    <input type="number" id="size-6" name="sizes[6]" min="0" class="form-control">
                                
                                    <label for="size-7">Size 7 Quantity:</label>
                                    <input type="number" id="size-7" name="sizes[7]" min="0" class="form-control">
                                
                                    <label for="size-8">Size 8 Quantity:</label>
                                    <input type="number" id="size-8" name="sizes[8]" min="0" class="form-control">
                                
                                    <label for="size-9">Size 9 Quantity:</label>
                                    <input type="number" id="size-9" name="sizes[9]" min="0" class="form-control">
                                
                                    <small id="size-error" class="text-danger"></small>
                                </div>
                            </div>
                        </div>
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row gx-2">
                                    <div class="col-sm-6 mb-3">
                                        <label class="form-label">Category</label>
                                        <select class="form-select" style="width: 150px;" name="category">
                                            <option value="">Select Category</option>
                                            <% for(let i=0; i<cat.length; i++) { %>
                                                <option value="<%= cat[i].name %>">
                                                    <%= cat[i].name %>
                                                </option>
                                            <% } %>
                                        </select>
                                        <span id="category-error" class="error-message"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card mb-2">
                            <div class="card-header">
                                <h4>Choose product image</h4>
                            </div>
                            <div class="card-body">
                                <div class="form-section">
                                    <h3>Select Images:</h3>
                                    <div id="imageUploadContainer" class="image-upload-container">
                                        <div class="image-input-row" id="imageInput1">
                                            <input type="file" class="form-control" name="productImages" id="input1" onchange="handleImageUpload(event, 1)" />
                                            <div class="image-cropper" id="cropper1">
                                                <img id="croppedImg1" alt="" style="max-width: 100%; height: auto;" />
                                                <button type="button" id="saveButton1" class="btn" onclick="saveImage(1)">
                                                    Save
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="croppedImagesPreview" class="preview-container">
                                    <h4>Preview Cropped Images:</h4>
                                    <div id="previewList" class="thumbnails-container"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <input class="btn" type="submit" value="Publish">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const cropperInstances = {};
    let uploadedImageCount = 0;

    function handleImageUpload(event, index) {
        const fileInput = event.target;
        const file = fileInput.files[0];
        if (!file) return;

        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Format',
                text: 'Only images are allowed'
            });
            fileInput.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const image = document.getElementById(`croppedImg${index}`);
            image.src = e.target.result;

            image.onload = function() {
                const cropperContainer = document.getElementById(`cropper${index}`);
                cropperContainer.style.display = "block";

                if (cropperInstances[index]) {
                    cropperInstances[index].destroy();
                }

                const cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    guides: true,
                    background: false,
                    autoCropArea: 0.8,
                    minCropBoxWidth: 100,
                    minCropBoxHeight: 100,
                    zoomable: true,
                    scalable: true,
                    movable: true,
                    responsive: true,
                    checkCrossOrigin: false
                });

                cropperInstances[index] = cropper;
            };
        };
        reader.readAsDataURL(file);
    }

    function saveImage(index) {
        const cropper = cropperInstances[index];
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({
            width: 800,
            height: 800,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });

        const imageInput = document.getElementById(`input${index}`);

        canvas.toBlob((blob) => {
            const fileName = `cropped-image-${Date.now()}.jpg`;
            const newFile = new File([blob], fileName, { type: "image/jpeg" });

            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(newFile);
            imageInput.files = dataTransfer.files;

            const previewList = document.getElementById("previewList");
            const thumbnail = document.createElement("div");
            thumbnail.className = "thumbnail";

            const img = document.createElement("img");
            img.src = canvas.toDataURL("image/jpeg");
            img.className = "cropped-preview";
            thumbnail.appendChild(img);

            const removeButton = document.createElement("button");
            removeButton.className = "remove-btn";
            removeButton.innerHTML = "Remove";
            removeButton.onclick = () => removeCroppedImage(thumbnail, imageInput, index);
            thumbnail.appendChild(removeButton);

            previewList.appendChild(thumbnail);

            const cropperContainer = document.getElementById(`cropper${index}`);
            cropperContainer.style.display = "none";
            cropper.destroy();
            delete cropperInstances[index];

            uploadedImageCount++;
            addNewImage(); 
        }, 'image/jpeg', 0.9);
    }

    function removeCroppedImage(thumbnail, imageInput, index) {
        const previewList = document.getElementById("previewList");
        previewList.removeChild(thumbnail);
        imageInput.value = '';

        const cropperContainer = document.getElementById(`cropper${index}`);
        cropperContainer.style.display = "none";

        if (cropperInstances[index]) {
            cropperInstances[index].destroy();
            delete cropperInstances[index];
        }

        uploadedImageCount--;

        const imageInputRow = document.getElementById(`imageInput${index}`);
        if (imageInputRow) {
            imageInputRow.remove();
        }
    }

    function addNewImage() {
        const fileInputCount = document.querySelectorAll('.image-input-row').length + 1;

        const newInput = document.createElement('div');
        newInput.className = 'image-input-row';
        newInput.id = `imageInput${fileInputCount}`;

        newInput.innerHTML = `
            <input
                type="file"
                class="form-control"
                name="productImages"
                id="input${fileInputCount}"
                onchange="handleImageUpload(event, ${fileInputCount})"
                accept="image/png, image/jpeg, image/jpg"
            />
            <div class="image-cropper" id="cropper${fileInputCount}" style="display: none;">
                <img id="croppedImg${fileInputCount}" alt="" style="max-width: 100%; height: auto;" />
                <button type="button" id="saveButton${fileInputCount}" class="btn" onclick="saveImage(${fileInputCount})">
                    Save Cropped Image
                </button>
            </div>
        `;

        document.getElementById('imageUploadContainer').appendChild(newInput);
    }

    function updateTotalQuantity() {
        const sizes = document.querySelectorAll('input[name^="sizes"]');
        let totalSizeStock = 0;
        sizes.forEach(input => {
            const value = input.value.trim();
            if (value !== "" && !isNaN(value) && parseInt(value) >= 0) {
                totalSizeStock += parseInt(value);
            }
        });
        const quantityInput = document.getElementById("totalQuantity");
        quantityInput.value = totalSizeStock || "";
        document.getElementById("quantity-error").textContent = "";
        document.getElementById("size-error").textContent = "";
    }

    function validateTotalQuantity() {
        const sizes = document.querySelectorAll('input[name^="sizes"]');
        const quantity = document.getElementById("totalQuantity").value.trim();
        let totalSizeStock = 0;
        sizes.forEach(input => {
            const value = input.value.trim();
            if (value !== "" && !isNaN(value) && parseInt(value) >= 0) {
                totalSizeStock += parseInt(value);
            }
        });

        if (quantity !== "" && !isNaN(quantity) && parseInt(quantity) >= 0) {
            if (totalSizeStock > parseInt(quantity)) {
                document.getElementById("quantity-error").textContent = "Total size stock cannot exceed total quantity.";
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Quantity',
                    text: 'Total size stock cannot exceed total quantity.',
                    confirmButtonText: 'OK'
                });
                return false;
            } else {
                document.getElementById("quantity-error").textContent = "";
            }
        }
        return true;
    }

    // Auto-update total quantity when size inputs change
    document.querySelectorAll('input[name^="sizes"]').forEach(input => {
        input.addEventListener('input', updateTotalQuantity);
    });

    document.getElementById("totalQuantity").addEventListener('input', validateTotalQuantity);

    // Initialize first image input
    document.addEventListener('DOMContentLoaded', () => {
        addNewImage();
    });

    // === ONLY ONE SUBMIT HANDLER (DUPLICATE REMOVED) ===
    document.getElementById('productForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        // Clear all error messages
        document.getElementById("productName-error").textContent = "";
        document.getElementById("description-error").textContent = "";
        document.getElementById("regularPrice-error").textContent = "";
        document.getElementById("salePrice-error").textContent = "";
        document.getElementById("quantity-error").textContent = "";
        document.getElementById("category-error").textContent = "";
        document.getElementById("size-error").textContent = "";

        let hasErrors = false;
        let errors = [];

        const productName = document.getElementById("product_name").value.trim();
        const description = document.getElementById("descriptionid").value.trim();
        const regularPrice = document.querySelector('input[name="regularPrice"]').value.trim();
        const salePrice = document.querySelector('input[name="salePrice"]').value.trim();
        const quantity = document.getElementById("totalQuantity").value.trim();
        const category = document.querySelector('select[name="category"]').value;
        const sizes = document.querySelectorAll('input[name^="sizes"]');
        const fileInputs = document.querySelectorAll('input[name="productImages"]');

        // Product Name
        if (!productName) {
            errors.push("Product Name is required.");
            document.getElementById("productName-error").textContent = "Product Name is required.";
            hasErrors = true;
        } else if (productName.length < 3 || productName.length > 15) {
            errors.push("Product Name must be 3-15 characters long.");
            document.getElementById("productName-error").textContent = "Product Name must be 3-15 characters long.";
            hasErrors = true;
        } else if (!/^[a-zA-Z0-9\s\-_.,()]+$/.test(productName)) {
            errors.push("Product Name can only contain letters, numbers, spaces and basic punctuation.");
            document.getElementById("productName-error").textContent = "Product Name can only contain letters, numbers, spaces and basic punctuation.";
            hasErrors = true;
        }

        // Description
        if (!description) {
            errors.push("Description is required.");
            document.getElementById("description-error").textContent = "Description is required.";
            hasErrors = true;
        } else if (description.length < 10 || description.length > 2000) {
            errors.push("Description must be between 10 and 2000 characters.");
            document.getElementById("description-error").textContent = "Description must be between 10 and 2000 characters.";
            hasErrors = true;
        }

        // Regular Price
        const regPrice = parseFloat(regularPrice);
        if (!regularPrice || isNaN(regPrice) || regPrice <= 0) {
            errors.push("Regular Price must be a positive number.");
            document.getElementById("regularPrice-error").textContent = "Regular Price must be a positive number.";
            hasErrors = true;
        }

        // Sale Price
        const salPrice = parseFloat(salePrice);
        if (!salePrice || isNaN(salPrice) || salPrice <= 0) {
            errors.push("Sale Price must be a positive number.");
            document.getElementById("salePrice-error").textContent = "Sale Price must be a positive number.";
            hasErrors = true;
        } else if (salPrice >= regPrice) {
            errors.push("Sale Price must be less than Regular Price.");
            document.getElementById("salePrice-error").textContent = "Sale Price must be less than Regular Price.";
            hasErrors = true;
        }

        // Quantity
        const qty = parseInt(quantity, 10);
        if (!quantity || isNaN(qty) || qty <= 0 || qty > 10000) {
            errors.push("Quantity must be a positive integer (max 10,000).");
            document.getElementById("quantity-error").textContent = "Quantity must be a positive integer (max 10,000).";
            hasErrors = true;
        }

        // Category
        if (!category) {
            errors.push("Category is required.");
            document.getElementById("category-error").textContent = "Category is required.";
            hasErrors = true;
        }

        // Sizes
        let totalSizeStock = 0;
        let hasSize = false;
        sizes.forEach(input => {
            const val = input.value.trim();
            const sizeQty = parseInt(val, 10);
            if (val !== "" && !isNaN(sizeQty) && sizeQty > 0) {
                hasSize = true;
                totalSizeStock += sizeQty;
            } else if (val !== "" && (isNaN(sizeQty) || sizeQty < 0)) {
                errors.push(`Size ${input.id.split('-')[1]} quantity must be a non-negative integer.`);
                document.getElementById("size-error").textContent = `Invalid size quantity.`;
                hasErrors = true;
            }
        });

        if (!hasSize) {
            errors.push("At least one size with quantity > 0 is required.");
            document.getElementById("size-error").textContent = "At least one size with quantity > 0 is required.";
            hasErrors = true;
        } else if (totalSizeStock > qty) {
            errors.push("Total size quantity cannot exceed total quantity.");
            document.getElementById("size-error").textContent = "Total size quantity cannot exceed total quantity.";
            hasErrors = true;
        }

        // Images
        let hasImages = false;
        fileInputs.forEach(input => {
            if (input.files && input.files.length > 0) hasImages = true;
        });
        if (!hasImages) {
            errors.push("At least one product image is required.");
            hasErrors = true;
        }

        // Show errors
        if (hasErrors) {
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                html: errors.join('<br>'),
                confirmButtonText: 'OK'
            });
            return;
        }

        // Submit via AJAX
        try {
            const formData = new FormData(this);
            const response = await fetch('/admin/addProducts', {
                method: 'POST',
                body: formData
            });

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error('Server error. Please try again.');
            }

            const data = await response.json();

            if (data.success) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Product added successfully',
                    showConfirmButton: true
                });
                window.location.href = '/admin/products';
            } else {
                throw new Error(data.message || 'Failed to add product');
            }
        } catch (error) {
            console.error('Submit error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to save product'
            });
        }
    });
</script>

<%- include("../../views/partials/admin/footer") %>