<%- include("../../views/partials/admin/header") %>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.2/dist/sweetalert2.min.css">
</head>

<style>
    .form-control, .form-select {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
        margin-bottom: 1rem;
    }
    .form-control[readonly] {
        background-color: #f5f5f5;
    }
    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: normal;
    }
    .btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .thumbnail {
        position: relative;
        display: inline-block;
        margin: 5px;
    }
    .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: red;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
    }
    .cropped-preview {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border: 1px solid #ddd;
    }
    .card {
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 20px;
    }
</style>

<section class="content-main">
    <div class="row">
        <div class="col-lg-7">
            <div class="card">
                <h3>Add New Product</h3>
                <form id="productForm">
                    <div>
                        <label>Product Name</label>
                        <input type="text" name="productName" class="form-control" id="product_name" required>
                    </div>

                    <div>
                        <label>Description</label>
                        <textarea name="description"" class="form-control" id="descriptionid" rows="4" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <label>Regular Price</label>
                            <input type="text" name="regularPrice" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label>Sale Price</label>
                            <input type="text" name="salePrice" class="form-control" required>
                        </div>
                        <!-- Total Quantity field is now HIDDEN -->
                        <div class="col-md-4" style="display:none;">
                            <label>Total Quantity (Auto-calculated)</label>
                            <input type="text" name="quantity" class="form-control" id="totalQuantity" readonly value="0">
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <label><strong>Size-wise Quantity</strong> (Optional – leave blank or 0 if not available)</label>
                        <div class="row g-3 align-items-end"> <!-- g-3 for better spacing -->
                            <div class="col-3 col-sm-2">
                                <label for="size6" class="form-label fw-bold text-center d-block">Size 6</label>
                                <input type="number" id="size6" name="sizes[6]" class="form-control size-input text-center" min="0" placeholder="0">
                            </div>
                            <div class="col-3 col-sm-2">
                                <label for="size7" class="form-label fw-bold text-center d-block">Size 7</label>
                                <input type="number" id="size7" name="sizes[7]" class="form-control size-input text-center" min="0" placeholder="0">
                            </div>
                            <div class="col-3 col-sm-2">
                                <label for="size8" class="form-label fw-bold text-center d-block">Size 8</label>
                                <input type="number" id="size8" name="sizes[8]" class="form-control size-input text-center" min="0" placeholder="0">
                            </div>
                            <div class="col-3 col-sm-2">
                                <label for="size9" class="form-label fw-bold text-center d-block">Size 9</label>
                                <input type="number" id="size9" name="sizes[9]" class="form-control size-input text-center" min="0" placeholder="0">
                            </div>
                            <!-- Add more sizes if needed -->
                            <div class="col-12 col-sm-4 mt-3">
                                <small class="text-muted">
                                     <strong><span id="liveTotal"></span></strong>
                                </small>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label>Category</label>
                        <select name="category" class="form-select" required>
                            <option value="">Select Category</option>
                            <% cat.forEach(c => { %>
                                <option value="<%= c.name %>"><%= c.name %></option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="card">
                        <h5>Add Product Images (Minimum 3)</h5>
                        <button type="button" class="btn btn-primary" id="chooseImageBtn">Choose Image</button>
                        <input type="file" id="imageInput" accept="image/*" style="display:none;">

                        <div id="cropperWrapper" style="display:none; margin:20px 0;">
                            <img id="imageToCrop" style="max-width:100%;">
                        </div>

                        <button type="button" class="btn btn-success" id="cropButton" style="display:none;">Crop & Add</button>

                        <div style="margin-top:15px;">
                            Added: <span id="imageCount">0</span>
                            <div id="previewList"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Publish Product</button>
                </form>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.2/dist/sweetalert2.all.min.js"></script>

<script>
    let cropper = null;
    const croppedBlobs = [];

    document.getElementById('chooseImageBtn').onclick = () => document.getElementById('imageInput').click();

    document.getElementById('imageInput').onchange = e => {
        if (!e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const img = document.getElementById('imageToCrop');
            img.src = ev.target.result;
            document.getElementById('cropperWrapper').style.display = 'block';
            document.getElementById('cropButton').style.display = 'block';
            if (cropper) cropper.destroy();
            cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    document.getElementById('cropButton').onclick = () => {
        if (!cropper) return;
        cropper.getCroppedCanvas({ width: 800, height: 800 }).toBlob(blob => {
            croppedBlobs.push(blob);
            const url = URL.createObjectURL(blob);

            const div = document.createElement('div');
            div.className = 'thumbnail';
            const img = document.createElement('img');
            img.src = url; img.className = 'cropped-preview';
            const btn = document.createElement('button');
            btn.className = 'remove-btn'; btn.innerHTML = '×';
            btn.onclick = () => {
                croppedBlobs.splice(croppedBlobs.indexOf(blob), 1);
                div.remove();
                document.getElementById('imageCount').textContent = croppedBlobs.length;
            };
            div.append(img, btn);
            document.getElementById('previewList').appendChild(div);
            document.getElementById('imageCount').textContent = croppedBlobs.length;

            document.getElementById('cropperWrapper').style.display = 'none';
            document.getElementById('cropButton').style.display = 'none';
            document.getElementById('imageInput').value = '';
            cropper.destroy(); cropper = null;
        }, 'image/jpeg');
    };

    // Update total quantity from sizes (still works even if field is hidden)
    document.querySelectorAll('.size-input').forEach(input => {
        input.addEventListener('input', () => {
            let total = 0;
            document.querySelectorAll('.size-input').forEach(i => total += parseInt(i.value) || 0);
            document.getElementById('totalQuantity').value = total;
        });
    });

    // Form submit
    document.getElementById('productForm').onsubmit = async e => {
        e.preventDefault();

        if (croppedBlobs.length < 3) {
            Swal.fire('Error', 'Please add at least 3 images', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('productName', document.getElementById('product_name').value);
        formData.append('description', document.getElementById('descriptionid').value);
        formData.append('regularPrice', document.querySelector('input[name="regularPrice"]').value);
        formData.append('salePrice', document.querySelector('input[name="salePrice"]').value);
        formData.append('quantity', document.getElementById('totalQuantity').value);
        formData.append('category', document.querySelector('select[name="category"]').value);

        document.querySelectorAll('input[name^="sizes"]').forEach(input => {
            if (input.value) formData.append(input.name, input.value);
        });

        croppedBlobs.forEach((blob, i) => {
            const file = new File([blob], `img${i}.jpg`, { type: 'image/jpeg' });
            formData.append('productImages', file);
        });

        try {
            const res = await fetch('/admin/addProducts', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                Swal.fire('Success', 'Product added!', 'success').then(() => location.href = '/admin/products');
            } else {
                Swal.fire('Error', data.message || 'Failed', 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Something went wrong', 'error');
        }
    };
</script>

<%- include("../../views/partials/admin/footer") %>