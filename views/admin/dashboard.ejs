<%- include("../../views/partials/admin/header") %>

<style>
    :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --info: #4895ef;
        --warning: #f72585;
        --danger: #e63946;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --light-gray: #e9ecef;
        --white: #ffffff;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --hover-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background-color: #f5f7fb;
        color: #333;
        line-height: 1.6;
    }

    .dashboard-container {
        display: flex;
        min-height: 100vh;
    }

    .main-content {
        flex: 1;
        padding: 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--light-gray);
    }

    .header h1 {
        font-size: 1.8rem;
        color: var(--dark);
        font-weight: 600;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary:hover {
        background: var(--secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--card-shadow);
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        align-items: center;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.5rem;
    }

    .stat-info {
        flex: 1;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stat-title {
        color: var(--gray);
        font-size: 0.9rem;
    }

    .stat-trend {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        margin-top: 5px;
    }

    .trend-up {
        color: #28a745;
    }

    .trend-down {
        color: #dc3545;
    }

    .charts-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--card-shadow);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .chart-actions select {
        border: 1px solid var(--light-gray);
        border-radius: 6px;
        padding: 5px 10px;
        background: white;
    }

    .chart-body {
        height: 400px;
        position: relative;
    }

    .data-sections {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .data-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--card-shadow);
    }

    .data-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .data-title {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .data-body {
        height: 300px;
        position: relative;
    }

    .error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #dc3545;
        font-size: 1rem;
        text-align: center;
        display: none;
        width: 100%;
    }

    .footer {
        text-align: center;
        padding: 20px;
        color: var(--gray);
        font-size: 0.9rem;
        border-top: 1px solid var(--light-gray);
    }

    @media (max-width: 992px) {
        .charts-container, .data-sections {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: 1fr;
        }
        
        .header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .header-actions {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>

<div class="dashboard-container">
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1>Dashboard Overview</h1>
            <div class="header-actions">
                <a href="/admin/salesReport" class="btn-primary">View Sales Report</a>
                <div class="user-info">
                    <div class="user-avatar">AD</div>
                    <div>Admin User</div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(67, 97, 238, 0.1); color: var(--primary);">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value">₹<%= (totalSalesAmount||0).toLocaleString() %></div>
                    <div class="stat-title">Total Sales</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(76, 201, 240, 0.1); color: var(--success);">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value"><%= totalOrders||0 %></div>
                    <div class="stat-title">Total Orders</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(247, 37, 133, 0.1); color: var(--warning);">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value"><%= pendingOrders||0 %></div>
                    <div class="stat-title">Pending Orders</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(72, 149, 239, 0.1); color: var(--info);">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value"><%= shippedOrders||0 %></div>
                    <div class="stat-title">Shipped Orders</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(33, 37, 41, 0.1); color: var(--dark);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value"><%= deliveredOrders||0 %></div>
                    <div class="stat-title">Delivered Orders</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(230, 57, 70, 0.1); color: var(--danger);">
                    <i class="fas fa-undo"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value"><%= returnedOrders||0 %></div>
                    <div class="stat-title">Returned Orders</div>
                </div>
            </div>
        </div>

        <!-- Sales Trend Chart -->
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Sales Trend</div>
                    <div class="chart-actions">
                        <select id="salesFilter">
                            <option value="monthly">Monthly</option>
                            <option value="yearly" selected>Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="salesChart"></canvas>
                    <div id="salesError" class="error-message">
                        Failed to load sales data.
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products & Categories -->
        <div class="data-sections">
            <div class="data-card">
                <div class="data-header">
                    <div class="data-title">Top Ordered Products</div>
                </div>
                <div class="data-body">
                    <canvas id="topOrderedProductsChart"></canvas>
                    <div id="topProductsError" class="error-message">
                        Failed to load products data.
                    </div>
                </div>
            </div>
            
            <div class="data-card">
                <div class="data-header">
                    <div class="data-title">Top Categories</div>
                </div>
                <div class="data-body">
                    <canvas id="topCategoriesChart"></canvas>
                    <div id="topCategoriesError" class="error-message">
                        Failed to load categories data.
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>© 2023 Admin Dashboard. All rights reserved.</p>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
    // API Endpoints (relative to /admin)
    const API = {
        sales:      '/admin/api/sales',
        products:   '/admin/api/top-products',
        categories: '/admin/api/top-categories'
    };

    // Helper: fetch JSON with error handling
    const fetchJSON = async (url, errorId) => {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (err) {
            console.error(`API Error [${url}]:`, err);
            const el = document.getElementById(errorId);
            if (el) el.style.display = 'block';
            return null;
        }
    };

    // 1. Sales Trend Chart - Updated to Line Graph
    let salesChart;
    const initSalesChart = async (filter = 'yearly') => {
        document.getElementById('salesError').style.display = 'none';
        const data = await fetchJSON(`${API.sales}?filter=${filter}`, 'salesError');
        if (!data || !data.labels || !data.values) return;

        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChart) salesChart.destroy();

        salesChart = new Chart(ctx, {
            type: 'line', // Changed from 'bar' to 'line'
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Sales (₹)',
                    data: data.values,
                    backgroundColor: 'rgba(67, 97, 238, 0.1)', // Added for fill
                    borderColor: '#4361ee',
                    borderWidth: 3,
                    pointBackgroundColor: '#4361ee',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: true, // Added for area under line
                    tension: 0.3 // Added for smooth curves
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `₹${ctx.parsed.y.toLocaleString()}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: v => '₹' + v.toLocaleString()
                        }
                    }
                }
            }
        });
    };

    // 2. Top Products Chart
    let topProductsChart;
    const initTopProductsChart = async () => {
        document.getElementById('topProductsError').style.display = 'none';
        const data = await fetchJSON(API.products, 'topProductsError');
        if (!data || data.length === 0) return;

        const labels = data.map(p => p.name).slice(0, 10);
        const values = data.map(p => p.quantity).slice(0, 10);

        const ctx = document.getElementById('topOrderedProductsChart').getContext('2d');
        if (topProductsChart) topProductsChart.destroy();

        topProductsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Orders',
                    data: values,
                    backgroundColor: '#4cc9f0',
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });
    };

    // 3. Top Categories Chart
    let topCategoriesChart;
    const initTopCategoriesChart = async () => {
        document.getElementById('topCategoriesError').style.display = 'none';
        const data = await fetchJSON(API.categories, 'topCategoriesError');
        if (!data || data.length === 0) return;

        const labels = data.map(c => c.name).slice(0, 10);
        const values = data.map(c => c.revenue).slice(0, 10);

        const ctx = document.getElementById('topCategoriesChart').getContext('2d');
        if (topCategoriesChart) topCategoriesChart.destroy();

        topCategoriesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Revenue (₹)',
                    data: values,
                    backgroundColor: '#f72585',
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `₹${ctx.parsed.y.toLocaleString()}`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: v => '₹' + (v/1000).toFixed(0) + 'K'
                        }
                    }
                }
            }
        });
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        initSalesChart();
        initTopProductsChart();
        initTopCategoriesChart();

        document.getElementById('salesFilter').addEventListener('change', e => {
            initSalesChart(e.target.value);
        });
    });
</script>

<%- include("../../views/partials/admin/footer") %>