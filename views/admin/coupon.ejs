<!DOCTYPE html>
<%- include("../../views/partials/admin/header") %>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #ebedfd;
            --surface: #ffffff;
            --background: #f8f9fa;
            --text: #212529;
            --text-light: #6c757d;
            --border: #e9ecef;
            --border-light: #f1f3f5;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-md: rgba(0, 0, 0, 0.1);
            --danger: #e63946;
            --success: #2a9d8f;
            --warning: #e9c46a;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--background); color: var(--text); padding: 2rem; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        h1 { font-weight: 600; font-size: 1.75rem; color: var(--text); }
        
        .card { 
            background: var(--surface); 
            border-radius: 16px; 
            box-shadow: 0 4px 20px var(--shadow); 
            padding: 2rem; 
            border: 1px solid var(--border-light);
        }
        .card-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 1.5rem; padding-bottom: 1rem; 
            border-bottom: 1px solid var(--border-light);
        }
        .card-title { font-size: 1.3rem; font-weight: 600; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-light); }
        th { font-weight: 500; color: var(--text-light); font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.5px; background: var(--background); }
        tr:hover td { background-color: var(--background); }
        .badge { padding: 0.4rem 0.9rem; border-radius: 50px; font-size: 0.75rem; font-weight: 600; }
        .badge-percentage { background: #e3f6f5; color: var(--success); }
        .btn { 
            display: inline-flex; align-items: center; justify-content: center; 
            padding: 0.7rem 1.4rem; border-radius: 10px; font-weight: 600; 
            font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; border: none; gap: 0.5rem;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(67,97,238,0.25); }
        .btn-primary:hover { background: #3a56d4; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(67,97,238,0.35); }
        .btn-outline { background: transparent; border: 1.5px solid var(--border); color: var(--text-light); }
        .btn-outline:hover { background: var(--background); }
        .btn-danger { background: var(--danger-light); color: var(--danger); }
        .btn-danger:hover { background: #f8d7da; transform: translateY(-1px); }
        
        .empty-state { text-align: center; padding: 4rem 2rem; background: var(--background); border: 2px dashed var(--border); border-radius: 16px; }
        .empty-state h3 { margin: 1rem 0 0.5rem; font-weight: 600; }
        
        /* Beautiful Modal Styling */
        .swal2-popup {
            border-radius: 20px !important;
            padding: 2rem !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15) !important;
        }
        .swal2-title {
            font-size: 1.6rem !important;
            font-weight: 700 !important;
            color: var(--text) !important;
            margin-bottom: 1.5rem !important;
        }
        .swal2-html-container {
            margin: 0 !important;
        }
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.95rem;
        }
        .swal2-input, .swal2-select {
            height: 48px !important;
            border-radius: 12px !important;
            border: 1.5px solid #ddd !important;
            padding: 0 1rem !important;
            font-size: 1rem !important;
            margin-bottom: 1.2rem !important;
            transition: all 0.3s ease;
        }
        .swal2-input:focus, .swal2-select:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 4px rgba(67,97,238,0.15) !important;
        }
        .swal2-confirm {
            background: var(--primary) !important;
            border-radius: 12px !important;
            padding: 0.8rem 2rem !important;
            font-weight: 600 !important;
        }
        .swal2-cancel {
            border-radius: 12px !important;
            padding: 0.8rem 1.5rem !important;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Coupon Management</h1>
        <button class="btn btn-primary" id="openNewCouponModal">
            New Coupon
        </button>
    </header>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Active Coupons</h2>
        </div>

        <% if (coupons && coupons.length > 0) { %>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Discount</th>
                        <th>Type</th>
                        <th>Min Purchase</th>
                        <th>Status</th>
                        <th>Usage Limit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% coupons.forEach(coupon => { %>
                    <tr>
                        <td><strong><%= coupon.code %></strong></td>
                        <td>
                            <strong><%= coupon.discount %><%= coupon.type === 'percentage' ? '%' : '₹' %></strong>
                            <% if (coupon.type === 'percentage' && coupon.maxDiscount) { %>
                            <div style="font-size: 0.75rem; color: var(--text-light);">(Max ₹<%= coupon.maxDiscount %>)</div>
                            <% } %>
                        </td>
                        <td>
                            <span class="badge <%= coupon.type === 'percentage' ? 'badge-percentage' : 'badge-fixed' %>">
                                <%= coupon.type === 'percentage' ? 'Percentage' : 'Fixed' %>
                            </span>
                        </td>
                        <td>₹<%= coupon.minPurchase || '0' %></td>
                        <td>
                            <% 
                                const expiryDate = new Date(coupon.expiryDate);
                                const today = new Date();
                                const daysLeft = Math.ceil((expiryDate - today) / (1000*60*60*24));
                                let statusClass = 'status-active', statusText = 'Active';
                                if (daysLeft <= 0) { statusClass = 'status-expired'; statusText = 'Expired'; }
                                else if (daysLeft <= 7) { statusClass = 'status-warning'; statusText = 'Expires soon'; }
                            %>
                            <div class="status-indicator"><span class="status-dot <%= statusClass %>"></span><span><%= statusText %></span></div>
                            <div style="font-size: 0.75rem; color: var(--text-light);"><%= expiryDate.toLocaleDateString() %></div>
                        </td>
                        <td>
                            <%= coupon.usageLimit || 'Unlimited' %>
                            <% if (coupon.usedCount !== undefined) { %>
                            <div style="font-size: 0.75rem; color: var(--text-light);">(<%= coupon.usedCount %> used)</div>
                            <% } %>
                        </td>
                        <td class="actions-cell">
                            <button type="button" class="btn btn-outline btn-sm"
                                onclick="openEditCoupon('<%= coupon._id %>', '<%= coupon.code %>', '<%= coupon.discount %>', '<%= coupon.minPurchase %>', '<%= coupon.maxDiscount %>', '<%= coupon.usageLimit %>', '<%= coupon.expiryDate.toISOString().split('T')[0] %>')">
                                Edit
                            </button>
                            <form action="/admin/coupons/delete/<%= coupon._id %>" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } else { %>
        <div class="empty-state">
            <h3>No coupons found</h3>
            <p>Get started by creating your first coupon code.</p>
            <button class="btn btn-primary" id="openNewCouponModalEmpty">Create New Coupon</button>
        </div>
        <% } %>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // CREATE MODAL — SUPER BEAUTIFUL
    function openNewCouponModal() {
        const today = new Date().toISOString().split('T')[0];
        const future = new Date();
        future.setDate(future.getDate() + 30);
        const defaultExpiry = future.toISOString().split('T')[0];

        Swal.fire({
            title: '<strong style="font-size:1.8rem; color:#333;">Create New Coupon</strong>',
            icon: 'success',
            html: `
                <div style="padding: 1.5rem; background: #f9fbff; border-radius: 16px; border: 1px solid #e0e7ff;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.8rem; margin-top:1rem;">
                        <div style="grid-column: span 2;">
                            <label class="form-label">Coupon Code</label>
                            <input type="text" id="code" class="swal2-input" placeholder="e.g. SUMMER90" 
                                   style="font-weight:600; letter-spacing:1px; font-size:1.1rem;" 
                                   oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')" required>
                        </div>
                        <div>
                            <label class="form-label">Discount Percentage (1–90%)</label>
                            <input type="number" id="discount" class="swal2-input" min="1" max="90" value="20" required>
                        </div>
                        <div>
                            <label class="form-label">Minimum Purchase Amount (₹)</label>
                            <input type="number" id="minPurchase" class="swal2-input" min="0" value="0">
                        </div>
                        <div>
                            <label class="form-label">Maximum Discount Cap (₹)</label>
                            <input type="number" id="maxDiscount" class="swal2-input" min="1" value="500" placeholder="e.g. 500" required>
                        </div>
                        <div>
                            <label class="form-label">Usage Limit (0 = Unlimited)</label>
                            <input type="number" id="usageLimit" class="swal2-input" min="0" value="100" required>
                        </div>
                        <div>
                            <label class="form-label">Expiry Date</label>
                            <input type="date" id="expiryDate" class="swal2-input" value="${defaultExpiry}" min="${today}" required>
                        </div>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Create Coupon',
            cancelButtonText: 'Cancel',
            width: '800px',
            padding: '2rem',
            preConfirm: () => {
                const code = document.getElementById('code').value.trim();
                const discount = parseFloat(document.getElementById('discount').value);
                const maxDiscount = parseFloat(document.getElementById('maxDiscount').value);

                if (!code) return Swal.showValidationMessage('Please enter coupon code');
                if (discount < 1 || discount > 90) return Swal.showValidationMessage('Discount must be 1–90%');
                if (!maxDiscount || maxDiscount < 1) return Swal.showValidationMessage('Max discount cap required');

                return {
                    code, discount, type: 'percentage',
                    minPurchase: document.getElementById('minPurchase').value || 0,
                    maxDiscount, usageLimit: document.getElementById('usageLimit').value,
                    expiryDate: document.getElementById('expiryDate').value
                };
            }
        }).then(result => {
            if (result.isConfirmed) {
                const fd = new FormData();
                Object.entries(result.value).forEach(([k,v]) => fd.append(k,v));
                fetch('/admin/coupons', {method:'POST', body:fd})
                    .then(r=>r.json()).then(d=>{
                        d.success ? Swal.fire('Success!', d.message, 'success').then(()=>location.reload())
                                  : Swal.fire('Error', d.message, 'error');
                    });
            }
        });
    }

    // EDIT MODAL — ALSO SUPER BEAUTIFUL
    function openEditCoupon(id, code, discount, minPurchase, maxDiscount, usageLimit, expiryDate) {
        Swal.fire({
            title: '<strong style="font-size:1.8rem; color:#333;">Edit Coupon</strong>',
            icon: 'info',
            html: `
                <div style="padding: 1.5rem; background: #f9fbff; border-radius: 16px; border: 1px solid #e0e7ff;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.8rem; margin-top:1rem;">
                        <div style="grid-column: span 2;">
                            <label class="form-label">Coupon Code</label>
                            <input type="text" id="code" class="swal2-input" value="${code}" 
                                   style="font-weight:600; letter-spacing:1px; font-size:1.1rem;" 
                                   oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')" required>
                        </div>
                        <div>
                            <label class="form-label">Discount Percentage (1–90%)</label>
                            <input type="number" id="discount" class="swal2-input" value="${discount}" min="1" max="90" required>
                        </div>
                        <div>
                            <label class="form-label">Minimum Purchase Amount (₹)</label>
                            <input type="number" id="minPurchase" class="swal2-input" value="${minPurchase || ''}" min="0">
                        </div>
                        <div>
                            <label class="form-label">Maximum Discount Cap (₹)</label>
                            <input type="number" id="maxDiscount" class="swal2-input" value="${maxDiscount || ''}" min="1" required>
                        </div>
                        <div>
                            <label class="form-label">Usage Limit (0 = Unlimited)</label>
                            <input type="number" id="usageLimit" class="swal2-input" value="${usageLimit || ''}" min="0" required>
                        </div>
                        <div>
                            <label class="form-label">Expiry Date</label>
                            <input type="date" id="expiryDate" class="swal2-input" value="${expiryDate}" required>
                        </div>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Save Changes',
            cancelButtonText: 'Cancel',
            width: '800px',
            padding: '2rem',
            preConfirm: () => {
                const discount = parseFloat(document.getElementById('discount').value);
                const maxDiscount = parseFloat(document.getElementById('maxDiscount').value);

                if (discount < 1 || discount > 90) return Swal.showValidationMessage('Discount must be 1–90%');
                if (!maxDiscount || maxDiscount < 1) return Swal.showValidationMessage('Max discount cap required');

                return {
                    code: document.getElementById('code').value.trim(),
                    discount, type: 'percentage',
                    minPurchase: document.getElementById('minPurchase').value || 0,
                    maxDiscount, usageLimit: document.getElementById('usageLimit').value,
                    expiryDate: document.getElementById('expiryDate').value
                };
            }
        }).then(result => {
            if (result.isConfirmed) {
                fetch(`/admin/coupons/edit/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(result.value)
                })
                .then(r=>r.json())
                .then(d=>{
                    d.success ? Swal.fire('Updated!', d.message, 'success').then(()=>location.reload())
                              : Swal.fire('Error', d.message, 'error');
                });
            }
        });
    }

    // Bind buttons
    document.getElementById('openNewCouponModal')?.addEventListener('click', openNewCouponModal);
    document.getElementById('openNewCouponModalEmpty')?.addEventListener('click', openNewCouponModal);
</script>
</body>
</html>