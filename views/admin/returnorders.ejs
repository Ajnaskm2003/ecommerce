<%- include("../../views/partials/admin/header") %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.2/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.2/dist/sweetalert2.all.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
    :root {
        --primary: #4f46e5;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --light: #f8fafc;
        --dark: #1e293b;
        --gray: #64748b;
        --border: #e2e8f0;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --radius: 12px;
        --transition: all 0.2s ease;
    }

    body { background: #f1f5f9; font-family: 'Inter', sans-serif; }

    .returns-page { padding: 2rem 1rem; max-width: 1400px; margin: 0 auto; }
    .page-title { font-size: 1.75rem; font-weight: 700; color: var(--dark); margin: 0; }
    .page-subtitle { color: var(--gray); font-size: 0.95rem; margin-top: 0.5rem; }

    .returns-container {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    .returns-table { width: 100%; min-width: 900px; border-collapse: collapse; font-size: 0.925rem; }
    .returns-table th {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        color: var(--dark);
        font-weight: 600;
        text-align: left;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .returns-table td {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        color: #334155;
        vertical-align: middle;
    }

    .returns-table tr:hover { background-color: #f8fafc; transition: var(--transition); }

    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.775rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }

    .status-pending { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
    .status-accepted { background: #ecfdf5; color: #065f46; border: 1px solid #86efac; }
    .status-rejected { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }

    .btn {
        padding: 0.5rem 0.875rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.825rem;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.775rem; }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3); }

    .no-actions { color: var(--gray); font-style: italic; font-size: 0.85rem; }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .new-row { animation: slideIn 0.4s ease-out; }

    /* Responsive */
    @media (max-width: 640px) {
        .returns-table, .returns-table thead, .returns-table tbody, .returns-table th, .returns-table td, .returns-table tr { display: block; }
        .returns-table thead tr { position: absolute; top: -9999px; left: -9999px; }
        .returns-table tr { border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem; padding: 1rem; background: white; box-shadow: var(--shadow-sm); }
        .returns-table td { border: none; padding: 0.5rem 0; position: relative; padding-left: 50%; text-align: right; }
        .returns-table td::before { content: attr(data-label); position: absolute; left: 0; width: 45%; font-weight: 600; color: var(--dark); text-align: left; }
    }
</style>

<div class="returns-page">
    <div class="page-header">
        <h1 class="page-title">Return Requests</h1>
        <p class="page-subtitle">Manage and process customer return requests</p>
    </div>

    <div class="returns-container">
        <div class="table-wrapper">
            <table class="returns-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Refund Amount</th>
                        <th>Return Reason</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="returnsTableBody">
                    <% returnOrders.forEach(order => { %>
                        <% order.orderItems.forEach(item => { %>
                            <% if(item.returnRequest && item.returnStatus === 'Pending') { %>
                                <tr data-order-id="<%= order._id %>" data-item-id="<%= item._id.toString() %>" class="existing-row">
                                    <td data-label="Order ID">
                                        <code style="background:#f1f5f9;padding:0.25rem 0.5rem;border-radius:6px;font-size:0.8rem;">
                                            <%= order.orderId %>
                                        </code>
                                    </td>
                                    <td data-label="Customer">
                                        <div class="customer-name"><%= order.userId.name %></div>
                                        <div class="customer-email"><%= order.userId.email %></div>
                                    </td>
                                    <td data-label="Product"><%= item.product?.productName || 'Product Unavailable' %></td>
                                    <td data-label="Refund" class="refund-amount">₹<%= order.totalAmount.toFixed(2) %></td>
                                    <td data-label="Reason"><%= item.returnReason %></td>
                                    <td data-label="Status">
                                        <span class="status-badge status-pending">Pending</span>
                                    </td>
                                    <td data-label="Actions">
                                        <div class="action-buttons">
                                            <button class="btn btn-success btn-sm" onclick="acceptReturn('<%= order._id %>', '<%= item._id %>')">
                                                Accept
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="rejectReturn('<%= order._id %>', '<%= item._id %>')">
                                                Reject
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% } else if (item.returnRequest) { %>
                                
                                <tr data-order-id="<%= order._id %>" data-item-id="<%= item._id.toString() %>">
                                    <td data-label="Order ID"><code style="background:#f1f5f9;padding:0.25rem 0.5rem;border-radius:6px;font-size:0.8rem;"><%= order.orderId %></code></td>
                                    <td data-label="Customer">
                                        <div class="customer-name"><%= order.userId.name %></div>
                                        <div class="customer-email"><%= order.userId.email %></div>
                                    </td>
                                    <td data-label="Product"><%= item.product?.productName || 'Unavailable' %></td>
                                    <td data-label="Refund" class="refund-amount">₹<%= order.totalAmount.toFixed(2) %></td>
                                    <td data-label="Reason"><%= item.returnReason %></td>
                                    <td data-label="Status">
                                        <span class="status-badge <%= item.returnStatus === 'Accepted' ? 'status-accepted' : 'status-rejected' %>">
                                            <%= item.returnStatus %>
                                        </span>
                                    </td>
                                    <td data-label="Actions"><span class="no-actions">No actions</span></td>
                                </tr>
                            <% } %>
                        <% }) %>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<%- include("../../views/partials/admin/footer") %>

<script>
    const socket = io();
    socket.emit('joinAdmin');

    socket.on("connect", () => console.log("Admin connected:", socket.id));

    
    socket.on("returnNotification", (data) => {
        const tableBody = document.getElementById("returnsTableBody");

        
        const existingRow = document.querySelector(
            `tr[data-order-id="${data.orderId}"][data-item-id="${data.itemId}"]`
        );

        const rowHTML = `
            <tr data-order-id="${data.orderId}" data-item-id="${data.itemId}" class="new-row">
                <td data-label="Order ID">
                    <code style="background:#f1f5f9;padding:0.25rem 0.5rem;border-radius:6px;font-size:0.8rem;">
                        ${data.displayOrderId || data.orderId}
                    </code>
                </td>
                <td data-label="Customer">
                    <div class="customer-name">${data.userName}</div>
                    <div class="customer-email">${data.userEmail}</div>
                </td>
                <td data-label="Product">${data.productName}</td>
                <td data-label="Refund" class="refund-amount">₹${Number(data.totalAmount).toFixed(2)}</td>
                <td data-label="Reason">${data.returnReason}</td>
                <td data-label="Status">
                    <span class="status-badge status-pending">Pending</span>
                </td>
                <td data-label="Actions">
                    <div class="action-buttons">
                        <button class="btn btn-success btn-sm" onclick="acceptReturn('${data.orderId}', '${data.itemId}')">
                            Accept
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="rejectReturn('${data.orderId}', '${data.itemId}')">
                            Reject
                        </button>
                    </div>
                </td>
            </tr>
        `;

        if (existingRow) {
            existingRow.outerHTML = rowHTML;
        } else {
            tableBody.insertAdjacentHTML('afterbegin', rowHTML);
        }

        Swal.fire({
            icon: "info",
            title: "New Return Request",
            html: `<strong>Order #${data.displayOrderId || data.orderId}</strong><br><small>${data.returnReason}</small>`,
            timer: 6000,
            toast: true,
            position: 'top-end',
            showConfirmButton: false
        });
    });

    
    socket.on("returnStatusUpdate", (update) => {
        const row = document.querySelector(
            `tr[data-order-id="${update.orderId}"][data-item-id="${update.itemId}"]`
        );

        if (!row) return console.warn("Row not found for update:", update);

        const statusCell = row.querySelector(".status-badge");
        const actionCell = row.cells[row.cells.length - 1];

        statusCell.className = `status-badge ${
            update.returnStatus === 'Accepted' ? 'status-accepted' : 'status-rejected'
        }`;
        statusCell.textContent = update.returnStatus;

        actionCell.innerHTML = '<span class="no-actions">No actions</span>';

        Swal.fire({
            icon: update.returnStatus === 'Accepted' ? 'success' : 'error',
            title: `Return ${update.returnStatus}`,
            text: `Order has been ${update.returnStatus.toLowerCase()}.`,
            timer: 5000,
            toast: true,
            position: 'top-end'
        });
    });

    // Accept & Reject Functions (unchanged)
    async function acceptReturn(orderId, itemId) {
        const { isConfirmed } = await Swal.fire({
            title: 'Accept Return?',
            text: 'This will refund the amount to the customer wallet.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Accept',
            confirmButtonColor: '#10b981'
        });
        if (!isConfirmed) return;

        Swal.fire({ title: 'Processing...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            const res = await fetch(`/admin/returns/accept/${orderId}/${itemId}`, { method: 'POST' });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Failed');
            Swal.fire('Accepted!', data.message, 'success');
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        }
    }

    async function rejectReturn(orderId, itemId) {
        const { isConfirmed } = await Swal.fire({
            title: 'Reject Return?',
            text: 'This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, Reject',
            confirmButtonColor: '#ef4444'
        });
        if (!isConfirmed) return;

        Swal.fire({ title: 'Processing...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            const res = await fetch(`/admin/returns/reject/${orderId}/${itemId}`, { method: 'POST' });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Failed');
            Swal.fire('Rejected!', data.message, 'success');
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        }
    }
</script>